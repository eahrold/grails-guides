<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>3.3 Configure Security</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/guide.css" type="text/css" media="screen, print" title="Style" charset="utf-8" />            
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Grails Framework Guide 
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/gettingStarted.html"><strong>1</strong><span>Getting Started</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/oauth2.html"><strong>2</strong><span>OAuth Authentication</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/appConfig.html"><strong>3</strong><span>Setting up your app</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/buildingTheApp.html"><strong>4</strong><span>Building your app</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/runningTheCompleteApp.html"><strong>5</strong><span>Running your Completed App</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/nextSteps.html"><strong>6</strong><span>Next Steps</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/helpWithGrails.html"><strong>7</strong><span>Do you need help with Grails?</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/oauth2.html">&lt;&lt; <strong>2</strong><span>OAuth Authentication</span></a></div>
                

                
                    <div class="toc-item next-right"><a href="../../guide/buildingTheApp.html"><strong>4</strong><span>Building your app</span> >></a></div>
                


                

                

<h2 id="oauthConfig">3.3 Configure Security</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-oauth-twitter/edit/master/src/main/docs/guide/oauthConfig.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>With our dependencies added, we need to configure security.</p>
</div>
<div class="paragraph">
<p>Create a file <code>application.groovy</code> with the following content <code>staticRules</code> configuration.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/conf/application.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">grails.plugin.springsecurity.controllerAnnotations.staticRules = [
        [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>,               <span class="key">access</span>: [<span class="string"><span class="delimiter">'</span><span class="content">permitAll</span><span class="delimiter">'</span></span>]],
        [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/error</span><span class="delimiter">'</span></span>,          <span class="key">access</span>: [<span class="string"><span class="delimiter">'</span><span class="content">permitAll</span><span class="delimiter">'</span></span>]],
        [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/index</span><span class="delimiter">'</span></span>,          <span class="key">access</span>: [<span class="string"><span class="delimiter">'</span><span class="content">permitAll</span><span class="delimiter">'</span></span>]],
        [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/index.gsp</span><span class="delimiter">'</span></span>,      <span class="key">access</span>: [<span class="string"><span class="delimiter">'</span><span class="content">permitAll</span><span class="delimiter">'</span></span>]],
        [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/shutdown</span><span class="delimiter">'</span></span>,       <span class="key">access</span>: [<span class="string"><span class="delimiter">'</span><span class="content">permitAll</span><span class="delimiter">'</span></span>]],
        [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/assets/**</span><span class="delimiter">'</span></span>,      <span class="key">access</span>: [<span class="string"><span class="delimiter">'</span><span class="content">permitAll</span><span class="delimiter">'</span></span>]],
        [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/**/js/**</span><span class="delimiter">'</span></span>,       <span class="key">access</span>: [<span class="string"><span class="delimiter">'</span><span class="content">permitAll</span><span class="delimiter">'</span></span>]],
        [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/**/css/**</span><span class="delimiter">'</span></span>,      <span class="key">access</span>: [<span class="string"><span class="delimiter">'</span><span class="content">permitAll</span><span class="delimiter">'</span></span>]],
        [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/**/images/**</span><span class="delimiter">'</span></span>,   <span class="key">access</span>: [<span class="string"><span class="delimiter">'</span><span class="content">permitAll</span><span class="delimiter">'</span></span>]],
        [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/**/favicon.ico</span><span class="delimiter">'</span></span>, <span class="key">access</span>: [<span class="string"><span class="delimiter">'</span><span class="content">permitAll</span><span class="delimiter">'</span></span>]]
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the next block to configure Grails Spring Security Rest Plugin:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/conf/application.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">grails {
        plugin {
                springsecurity {
                        rest {
                                token {
                                        validation {
                                                useBearerToken = <span class="predefined-constant">false</span> <i class="conum" data-value="1"></i><b>(1)</b>
                                                enableAnonymousAccess = <span class="predefined-constant">true</span> <i class="conum" data-value="2"></i><b>(2)</b>
                                        }
                                        storage {
                                                jwt {
                                                        secret = <span class="string"><span class="delimiter">'</span><span class="content">foobar123</span><span class="delimiter">'</span></span>*<span class="integer">4</span> <i class="conum" data-value="3"></i><b>(3)</b>
                                                }
                                        }
                                }
                                oauth {
                                        frontendCallbackUrl = { <span class="predefined-type">String</span> tokenValue -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">http://127.0.0.1:8080/auth/success?token=</span><span class="inline"><span class="inline-delimiter">${</span>tokenValue<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span> } <i class="conum" data-value="4"></i><b>(4)</b>
                                        twitter {
                                                client = org.pac4j.oauth.client.TwitterClient <i class="conum" data-value="5"></i><b>(5)</b>
                                                key = <span class="string"><span class="delimiter">'</span><span class="content">${TWITTER_KEY}</span><span class="delimiter">'</span></span> <i class="conum" data-value="6"></i><b>(6)</b>
                                                secret = <span class="string"><span class="delimiter">'</span><span class="content">${TWITTER_SECRET}</span><span class="delimiter">'</span></span> <i class="conum" data-value="7"></i><b>(7)</b>
                                                defaultRoles = <span class="type">[]</span> <i class="conum" data-value="8"></i><b>(8)</b>
                                        }
                                }
                        }
                        providerNames = [<span class="string"><span class="delimiter">'</span><span class="content">anonymousAuthenticationProvider</span><span class="delimiter">'</span></span>] <i class="conum" data-value="9"></i><b>(9)</b>
                }
        }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You must disable bearer token support to register your own tokenReader implementation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Enable anonymous access to URL&#8217;s where the Grails Spring Security Rest plugin&#8217;s filters are applied</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Required secret which is used to sign the JWT tokens.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Callback url - after authentication with Twitter, this callback url will be invoked with a JWT token which authenticates the user</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Which pac4j client to use; in our case the Twitter client</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Supply your Twitter Consumer Key (API Key) as the System Property <code>TWITTER_KEY</code> when you start the app.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Supply your Twitter Consumer Secret (API Secret) as the System Property <code>TWITTER_SECRET</code> when you start the app.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Specific roles that Twitter authenticated users get.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>We are going to authenticate our users only against Twitter. Thus, we use only the anonymous authentication provider. Read more about <a href="https://grails-plugins.github.io/grails-spring-security-core/latest/#authenticationProviders">Authentication Providers</a> in Spring Security Core Plugin documentation.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To start the app you will need to supply <code>client_id</code> and <code>client_secret</code> as system properties. e.g.:</p>
</div>
<div class="paragraph">
<p>`./gradlew -DTWITTER_KEY=XXXXXX -DTWITTER_SECRET=XXXX bootRun</p>
</div>
<div class="paragraph">
<p>We want our app stateless by default with some endpoints which allow anonymous access.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/conf/application.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="predefined-type">String</span> ANONYMOUS_FILTERS = <span class="string"><span class="delimiter">'</span><span class="content">anonymousAuthenticationFilter,restTokenValidationFilter,restExceptionTranslationFilter,filterInvocationInterceptor</span><span class="delimiter">'</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
grails.plugin.springsecurity.filterChain.chainMap = [
                [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/dbconsole/**</span><span class="delimiter">'</span></span>,      <span class="key">filters</span>: <span class="string"><span class="delimiter">'</span><span class="content">none</span><span class="delimiter">'</span></span>],
                [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/assets/**</span><span class="delimiter">'</span></span>,      <span class="key">filters</span>: <span class="string"><span class="delimiter">'</span><span class="content">none</span><span class="delimiter">'</span></span>],
                [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/**/js/**</span><span class="delimiter">'</span></span>,       <span class="key">filters</span>: <span class="string"><span class="delimiter">'</span><span class="content">none</span><span class="delimiter">'</span></span>],
                [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/**/css/**</span><span class="delimiter">'</span></span>,      <span class="key">filters</span>: <span class="string"><span class="delimiter">'</span><span class="content">none</span><span class="delimiter">'</span></span>],
                [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/**/images/**</span><span class="delimiter">'</span></span>,   <span class="key">filters</span>: <span class="string"><span class="delimiter">'</span><span class="content">none</span><span class="delimiter">'</span></span>],
                [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/**/favicon.ico</span><span class="delimiter">'</span></span>, <span class="key">filters</span>: <span class="string"><span class="delimiter">'</span><span class="content">none</span><span class="delimiter">'</span></span>],
                [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>, <span class="key">filters</span>: ANONYMOUS_FILTERS], <i class="conum" data-value="1"></i><b>(1)</b>
                [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/book/show/*</span><span class="delimiter">'</span></span>, <span class="key">filters</span>: ANONYMOUS_FILTERS],  <i class="conum" data-value="1"></i><b>(1)</b>
                [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/bookFavourite/index</span><span class="delimiter">'</span></span>, <span class="key">filters</span>: ANONYMOUS_FILTERS], <i class="conum" data-value="1"></i><b>(1)</b>
                [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/auth/success</span><span class="delimiter">'</span></span>, <span class="key">filters</span>: ANONYMOUS_FILTERS], <i class="conum" data-value="1"></i><b>(1)</b>
                [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/oauth/authenticate/twitter</span><span class="delimiter">'</span></span>, <span class="key">filters</span>: ANONYMOUS_FILTERS], <i class="conum" data-value="1"></i><b>(1)</b>
                [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/oauth/callback/twitter</span><span class="delimiter">'</span></span>, <span class="key">filters</span>: ANONYMOUS_FILTERS], <i class="conum" data-value="1"></i><b>(1)</b>
                [<span class="key">pattern</span>: <span class="string"><span class="delimiter">'</span><span class="content">/**</span><span class="delimiter">'</span></span>, <span class="key">filters</span>: <span class="string"><span class="delimiter">'</span><span class="content">JOINED_FILTERS,-anonymousAuthenticationFilter,-exceptionTranslationFilter,-authenticationProcessingFilter,-securityContextPersistenceFilter,-rememberMeAuthenticationFilter</span><span class="delimiter">'</span></span>],  <i class="conum" data-value="1"></i><b>(1)</b>
]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>stateless chain that allows anonymous access when no token is sent. If however a token is on the request, it will be validated.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>/** is a stateless chain that doesn&#8217;t allow anonymous access. Thus, the token will always be required, and if missing, a Bad Request reponse will be sent back to the client.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We are not persisting User information in the database. You may have noticed we don&#8217;t have <code>User</code>, <code>Role</code>, <code>UserRole</code> domain classes in the project. Neither we setup configuration values such as <code>userLookUp.userDomainClass</code> etc.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we override the <code>login/auth</code> view. So that we no longer show a username/password form in that page.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/views/login/auth.gsp</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">&lt;html&gt;
&lt;head&gt;
    &lt;meta name=<span class="string"><span class="delimiter">&quot;</span><span class="content">layout</span><span class="delimiter">&quot;</span></span> content=<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">${</span>gspLayout ?: <span class="string"><span class="delimiter">'</span><span class="content">main</span><span class="delimiter">'</span></span><span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>/&gt;
    &lt;title&gt;&lt;<span class="key">g</span>:message code=<span class="string"><span class="delimiter">'</span><span class="content">springSecurity.login.title</span><span class="delimiter">'</span></span>/&gt;&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">title&gt;</span></span><span class="error">
</span>&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">head&gt;</span></span><span class="error">
</span>
&lt;body&gt;
&lt;div id=<span class="string"><span class="delimiter">&quot;</span><span class="content">login</span><span class="delimiter">&quot;</span></span>&gt;
    &lt;div <span class="type">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">inner centered</span><span class="delimiter">&quot;</span></span> &gt;
        &lt;<span class="class">div</span> <span class="type">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fheader</span><span class="delimiter">&quot;</span></span>&gt;&lt;<span class="class">g</span>:message code=<span class="string"><span class="delimiter">'</span><span class="content">springSecurity.login.header</span><span class="delimiter">'</span></span>/&gt;&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">div&gt;</span></span><span class="error">
</span>        &lt;<span class="key">g</span>:<span class="keyword">if</span> test=<span class="string"><span class="delimiter">'</span><span class="content">${flash.message}</span><span class="delimiter">'</span></span>&gt;
            &lt;div <span class="type">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">login_message</span><span class="delimiter">&quot;</span></span>&gt;<span class="error">$</span>{flash.message}&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">div&gt;</span></span><span class="error">
</span>        &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">g:if&gt;</span></span><span class="error">
</span>    &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">div&gt;</span></span><span class="error">
</span>&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">div&gt;</span></span><span class="error">
</span>&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">body&gt;</span></span><span class="error">
</span>&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">html&gt;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We don&#8217;t include a button to SignIn with Twitter in that page because we have included that button in root layout <em>main.gsp</em> file.</p>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/oauth2.html">&lt;&lt; <strong>2</strong><span>OAuth Authentication</span></a></div>
                
                    <div class="toc-item next-right"><a href="../../guide/buildingTheApp.html"><strong>4</strong><span>Building your app</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title" style="text-align: right"><a href="https://travis-ci.org/grails-guides/grails-oauth-twitter"><img src="https://travis-ci.org/grails-guides/grails-oauth-twitter.svg?branch=master" /></a></div>            
                 <div class="local-title">
                    <a href="https://github.com/grails-guides/grails-oauth-twitter">
                    <svg height="35" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="35" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></a> &nbsp;&nbsp;Get the Code
                </div>
                <div class="menu">
                    <div class="input-group">                        
                        <button href="#" onclick="document.getElementById('github-url').value='git@github.com:grails-guides/grails-oauth-twitter.git'" class="codeButton">SSH</button>
                        <button onclick="document.getElementById('github-url').value='https://github.com/grails-guides/grails-oauth-twitter.git'" class="codeButton">HTTPS</button>
                        <button onclick="document.getElementById('github-url').value='https://github.com/grails-guides/grails-oauth-twitter'" class="codeButton">Subversion</button>
                    </div>
       
                    <div class="input-group">                    
                        <!-- Target -->
                        <input id="github-url" value="git@github.com:grails-guides/grails-oauth-twitter.git" type="text" />

                        <!-- Trigger -->
                        <button class="clipbtn" type="button" data-clipboard-target="#github-url">

                            <img width="13" src="../img/clippy.svg" alt="Copy to clipboard">
                        </button>       

                    </div>
                    <div class="input-group">
                      <a href="https://github.com/grails-guides/grails-oauth-twitter/archive/master.zip" class="downloadButton">Download ZIP</a>
                    </div>
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing. 
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
