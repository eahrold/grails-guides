<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>4.1 Creating the Rule</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/guide.css" type="text/css" media="screen, print" title="Style" charset="utf-8" />            
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Grails Framework Guide 
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/training.html"><strong>1</strong><span>Grails Training</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/gettingStarted.html"><strong>2</strong><span>Getting Started</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/writingTheApp.html"><strong>3</strong><span>Writing the Application</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/writingCustomRule.html"><strong>4</strong><span>Writing a custom Rule</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/helpWithGrails.html"><strong>5</strong><span>Do you need help with Grails?</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/writingTheApp.html">&lt;&lt; <strong>3</strong><span>Writing the Application</span></a></div>
                

                
                    <div class="toc-item next-right"><a href="../../guide/helpWithGrails.html"><strong>5</strong><span>Do you need help with Grails?</span> >></a></div>
                


                

                

<h2 id="customRule">4.1 Creating the Rule</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-codenarc/edit/master/src/main/docs/guide/customRule.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="sect2">
<h3 id="_create_the_project">Create the project</h3>
<div class="paragraph">
<p>We need to create a new Groovy project because we want to package the rule in its own jar file using Gradle.</p>
</div>
<div class="listingblock">
<div class="title">/codenarc-rule/build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">plugins {
    id <span class="string"><span class="delimiter">'</span><span class="content">groovy</span><span class="delimiter">'</span></span>
}

repositories {
    jcenter()
}

dependencies {
    implementation <span class="string"><span class="delimiter">'</span><span class="content">org.codenarc:CodeNarc:1.4</span><span class="delimiter">'</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
    testCompile <span class="string"><span class="delimiter">'</span><span class="content">junit:junit:4.12</span><span class="delimiter">'</span></span>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Only need CodeNarc dependency</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In order to be able to user this new CodeNarc rule in our Grails application we need to make sure that the jar file
is available in the classpath during the <code>codenarcMain</code> taks:</p>
</div>
<div class="listingblock">
<div class="title">/gradle/codenarc.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">codenarcMain.dependsOn <span class="string"><span class="delimiter">'</span><span class="content">:codenarc-rule:jar</span><span class="delimiter">'</span></span> <i class="conum" data-value="1"></i><b>(1)</b>

tasks.withType(CodeNarc) { <i class="conum" data-value="2"></i><b>(2)</b>
    codenarcClasspath += files(<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">${</span>rootProject.projectDir<span class="inline-delimiter">}</span></span><span class="content">/codenarc-rule/build/libs/codenarc-rule.jar</span><span class="delimiter">&quot;</span></span>)
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>CodeNarc tasks depend on the jar being generated</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add the jar to the <code>codenarcClasspath</code></td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_define_the_rule">Define the rule</h4>
<div class="paragraph">
<p>The first step is create a meta-information file with the information about the rule we want to create:</p>
</div>
<div class="listingblock">
<div class="title">/codenarc-rule/src/main/resources/rulesets/grails-extra.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;ruleset</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://codenarc.org/ruleset/1.0</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://codenarc.org/ruleset/1.0 http://codenarc.org/ruleset-schema.xsd</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">xsi:noNamespaceSchemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://codenarc.org/ruleset-schema.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;description&gt;</span>Extra Grails rules<span class="tag">&lt;/description&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tag">&lt;rule</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">'</span><span class="content">org.codenarc.rule.grails.GrailsTransactionalRule</span><span class="delimiter">'</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tag">&lt;/ruleset&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The description of the group of rules.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>One <code>rule</code> element per rule we create.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Second we create a properties file with the description of the rule in both plain text and html. The messages will be
used in the html report:</p>
</div>
<div class="listingblock">
<div class="title">/codenarc-rule/src/main/resources/codenarc-messages.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">GrailsTransactional.description=Check that @org.springframework.transaction.annotation.Transactional is used instead of org.springframework.transaction.annotation.Transactional.
GrailsTransactional.description.html=Check that &lt;em&gt;@grails.gorm.transactions.Transactional&lt;/em&gt; is used instead of &lt;em&gt;org.springframework.transaction.annotation.Transactional&lt;/em&gt;.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_implement_the_rule">Implement the rule</h3>
<div class="paragraph">
<p>Finally, we implement the rule:</p>
</div>
<div class="listingblock">
<div class="title">/codenarc-rule/src/main/groovy/org/codenarc/rule/grails/GrailsTransactionalRule.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> org.codenarc.rule.grails

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">org.codehaus.groovy.ast.AnnotatedNode</span>
<span class="keyword">import</span> <span class="include">org.codehaus.groovy.ast.AnnotationNode</span>
<span class="keyword">import</span> <span class="include">org.codehaus.groovy.ast.ImportNode</span>
<span class="keyword">import</span> <span class="include">org.codehaus.groovy.ast.ModuleNode</span>
<span class="keyword">import</span> <span class="include">org.codenarc.rule.AbstractAstVisitor</span>
<span class="keyword">import</span> <span class="include">org.codenarc.rule.AbstractAstVisitorRule</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">GrailsTransactionalRule</span> <span class="directive">extends</span> AbstractAstVisitorRule { <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="type">int</span> priority = <span class="integer">2</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="predefined-type">String</span> name = <span class="string"><span class="delimiter">'</span><span class="content">GrailsTransactional</span><span class="delimiter">'</span></span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="predefined-type">Class</span> astVisitorClass = GrailsTransactionalVisitor <i class="conum" data-value="4"></i><b>(4)</b>
}

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">GrailsTransactionalVisitor</span> <span class="directive">extends</span> AbstractAstVisitor { <i class="conum" data-value="5"></i><b>(5)</b>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> SPRING_TRANSACTIONAL = <span class="string"><span class="delimiter">'</span><span class="content">org.springframework.transaction.annotation.Transactional</span><span class="delimiter">'</span></span>
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> ERROR_MSG = <span class="string"><span class="delimiter">'</span><span class="content">Do not use Spring @Transactional, use @grails.gorm.transactions.Transactional instead</span><span class="delimiter">'</span></span>

    <span class="annotation">@Override</span>
    <span class="type">void</span> visitAnnotations(AnnotatedNode node) { <i class="conum" data-value="6"></i><b>(6)</b>
        node.annotations.each { AnnotationNode annotationNode -&gt;
            <span class="predefined-type">String</span> annotation = annotationNode.classNode.text
            <span class="keyword">if</span> (annotation == SPRING_TRANSACTIONAL) {
                addViolation(node, ERROR_MSG)
            }
        }

        <span class="local-variable">super</span>.visitAnnotations(node)
    }

    <span class="annotation">@Override</span>
    <span class="type">void</span> visitImports(ModuleNode node) { <i class="conum" data-value="7"></i><b>(7)</b>
        node.imports.each { ImportNode importNode -&gt;
            <span class="predefined-type">String</span> importClass = importNode.className

            <span class="keyword">if</span> (importClass == SPRING_TRANSACTIONAL) {
                node.lineNumber = importNode.lineNumber <i class="conum" data-value="8"></i><b>(8)</b>
                addViolation(node, ERROR_MSG)
            }
        }

        <span class="local-variable">super</span>.visitImports(node)
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The rule needs to extend from <code>AbstractAstVisitorRule</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the violation priority</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The name of the rule. It needs to be the same as defined previously in the meta-information file</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The class that implements the rule</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The visitor class needs to extend from <code>AbstractAstVisitor</code></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Check the annotations of the class and methods and in case that Spring <code>@Transactional</code> is used, add a new violation</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Check the imports of the class and is case of Spring <code>@Transactional</code> is imported, add a new violation</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>It&#8217;s important to set the <code>lineNumber</code> of the node because if not, the violation won&#8217;t be added</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_testing">Testing</h3>
<div class="paragraph">
<p>And of course we need to write tests to make sure that everything is working as expected:</p>
</div>
<div class="listingblock">
<div class="title">/codenarc-rule/src/test/groovy/org/codenarc/rule/grails/GrailsTransactionalRuleTest.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> org.codenarc.rule.grails

<span class="keyword">import</span> <span class="include">org.codenarc.rule.AbstractRuleTestCase</span>
<span class="keyword">import</span> <span class="include">org.codenarc.rule.Rule</span>
<span class="keyword">import</span> <span class="include">org.codenarc.rule.Violation</span>
<span class="keyword">import</span> <span class="include">org.junit.Test</span>

<span class="type">class</span> <span class="class">GrailsTransactionalRuleTest</span> <span class="directive">extends</span> AbstractRuleTestCase { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> Rule createRule() { <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="keyword">return</span> <span class="keyword">new</span> GrailsTransactionalRule()
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> testGrailsTransactionalIsAllowedOnClassWithImport() {
        <span class="directive">final</span> SOURCE = <span class="string"><span class="delimiter">'''</span><span class="content"> <i class="conum" data-value="3"></i><b>(3)</b>
            import grails.gorm.transactions.Transactional

            @Transactional
            class TestService {
            }
        </span><span class="delimiter">'''</span></span>

        assertNoViolations(SOURCE) <i class="conum" data-value="4"></i><b>(4)</b>
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> testGrailsTransactionalIsAllowedOnClassWithFullpackageAnnotation() {
        <span class="directive">final</span> SOURCE = <span class="string"><span class="delimiter">'''</span><span class="content">
            @grails.gorm.transactions.Transactional
            class TestService {
            }
        </span><span class="delimiter">'''</span></span>

        assertNoViolations(SOURCE)
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> testGrailsTransactionalIsAllowedOnMethodWithImport() {
        <span class="directive">final</span> SOURCE = <span class="string"><span class="delimiter">'''</span><span class="content">
            import grails.gorm.transactions.Transactional

            class TestService {
                @Transactional
                void foo() {
                }
            }
        </span><span class="delimiter">'''</span></span>

        assertNoViolations(SOURCE)
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> testGrailsTransactionalIsAllowedOnMethodWithFullpackageAnnotation() {
        <span class="directive">final</span> SOURCE = <span class="string"><span class="delimiter">'''</span><span class="content">
            class TestService {
                @grails.gorm.transactions.Transactional
                void foo() {
                }
            }
        </span><span class="delimiter">'''</span></span>

        assertNoViolations(SOURCE)
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> testSpringTransactionalIsNotAllowedOnClassWithImport() {
        <span class="directive">final</span> SOURCE = <span class="string"><span class="delimiter">'''</span><span class="content">
            import org.springframework.transaction.annotation.Transactional

            @Transactional
            class TestService {
            }
        </span><span class="delimiter">'''</span></span>

        <i class="conum" data-value="5"></i><b>(5)</b>
        assertSingleViolation(SOURCE) { Violation violation -&gt;
            violation.rule.priority == <span class="integer">2</span> &amp;&amp;
            violation.rule.name == <span class="string"><span class="delimiter">'</span><span class="content">GrailsTransactional</span><span class="delimiter">'</span></span>
        }
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> testSpringTransactionalIsNotAllowedOnClassWithFullpackageAnnotation() {
        <span class="directive">final</span> SOURCE = <span class="string"><span class="delimiter">'''</span><span class="content">
            @org.springframework.transaction.annotation.Transactional
            class TestService {
            }
        </span><span class="delimiter">'''</span></span>

        assertSingleViolation(SOURCE) { Violation violation -&gt;
            violation.rule.priority == <span class="integer">2</span> &amp;&amp;
            violation.rule.name == <span class="string"><span class="delimiter">'</span><span class="content">GrailsTransactional</span><span class="delimiter">'</span></span>
        }
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> testSpringTransactionalIsNotAllowedOnMethodWithImport() {
        <span class="directive">final</span> SOURCE = <span class="string"><span class="delimiter">'''</span><span class="content">
            import org.springframework.transaction.annotation.Transactional

            class TestService {
                @Transactional
                void foo() {
                }
            }
        </span><span class="delimiter">'''</span></span>

        assertSingleViolation(SOURCE) { Violation violation -&gt;
            violation.rule.priority == <span class="integer">2</span> &amp;&amp;
                violation.rule.name == <span class="string"><span class="delimiter">'</span><span class="content">GrailsTransactional</span><span class="delimiter">'</span></span>
        }
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> testSpringTransactionalIsNotAllowedOnMethodWithFullpackageAnnotation() {
        <span class="directive">final</span> SOURCE = <span class="string"><span class="delimiter">'''</span><span class="content">
            class TestService {
                @org.springframework.transaction.annotation.Transactional
                void foo() {
                }
            }
        </span><span class="delimiter">'''</span></span>

        assertSingleViolation(SOURCE) { Violation violation -&gt;
            violation.rule.priority == <span class="integer">2</span> &amp;&amp;
                violation.rule.name == <span class="string"><span class="delimiter">'</span><span class="content">GrailsTransactional</span><span class="delimiter">'</span></span>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The test class needs to extend from <code>AbstractRuleTestCase</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Instantiate the rule we want to test</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Write the source code we want to test as a String</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>In this case, as we use Grails <code>@Transactional</code> we expect no violations</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>As we use Spring <code>@Transactional</code> we expect to have one violation</td>
</tr>
</table>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/writingTheApp.html">&lt;&lt; <strong>3</strong><span>Writing the Application</span></a></div>
                
                    <div class="toc-item next-right"><a href="../../guide/helpWithGrails.html"><strong>5</strong><span>Do you need help with Grails?</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title" style="text-align: right"><a href="https://travis-ci.org/grails-guides/grails-codenarc"><img src="https://travis-ci.org/grails-guides/grails-codenarc.svg?branch=master" /></a></div>            
                 <div class="local-title">
                    <a href="https://github.com/grails-guides/grails-codenarc">
                    <svg height="35" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="35" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></a> &nbsp;&nbsp;Get the Code
                </div>
                <div class="menu">
                    <div class="input-group">                        
                        <button href="#" onclick="document.getElementById('github-url').value='git@github.com:grails-guides/grails-codenarc.git'" class="codeButton">SSH</button>
                        <button onclick="document.getElementById('github-url').value='https://github.com/grails-guides/grails-codenarc.git'" class="codeButton">HTTPS</button>
                        <button onclick="document.getElementById('github-url').value='https://github.com/grails-guides/grails-codenarc'" class="codeButton">Subversion</button>
                    </div>
       
                    <div class="input-group">                    
                        <!-- Target -->
                        <input id="github-url" value="git@github.com:grails-guides/grails-codenarc.git" type="text" />

                        <!-- Trigger -->
                        <button class="clipbtn" type="button" data-clipboard-target="#github-url">

                            <img width="13" src="../img/clippy.svg" alt="Copy to clipboard">
                        </button>       

                    </div>
                    <div class="input-group">
                      <a href="https://github.com/grails-guides/grails-codenarc/archive/master.zip" class="downloadButton">Download ZIP</a>
                    </div>
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing.
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
